<template>
  <div class="page-container">

    <div v-if="movieDetail" class="movie-detail-container">
      <!-- Ìó§Îçî ÏÑπÏÖò: ÏòÅÌôî Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
      <div class="movie-header">
        <div class="movie-basic-info">
          <img :src="movieDetail.poster_path" :alt="movieDetail.title" class="movie-poster" />
          <div class="movie-info">
            <h1 class="movie-title">{{ movieDetail.title }}</h1>
            <p class="release-date">Í∞úÎ¥âÏùº: {{ movieDetail.release_date }}</p>
            <p class="overview">{{ movieDetail.overview }}</p>

            <div class="action-buttons">
              <!-- Ï∞úÌïòÍ∏∞ Î≤ÑÌäºÏóê ÌåùÏóÖ Î©îÏãúÏßÄ Ï∂îÍ∞Ä -->
              <!-- Ï∞úÌïòÍ∏∞ Î≤ÑÌäº -->
              <button @click="toggleFavorite" class="favorite-btn" :class="{ 'is-favorite': isFavorite }">
                <span class="star-icon">‚òÖ</span>
                {{ isFavorite ? "Remove from Favorites" : "Add to Favorites" }}
                <span class="popup-message" :class="{ show: showFavPopup }">
                  {{ favPopupMessage }}
                  <span class="popup-emoji">{{ isFavorite ? "üíñ" : "üíî" }}</span>
                </span>
              </button>

              <!-- ÏòÅÌôî ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ÌÜ†Í∏Ä Î≤ÑÌäº -->
              <button @click="toggleMovieDetails" class="details-btn">
                {{ showDetails ? 'Hide Details ‚ñ≤' : 'Show Details ‚ñº' }}
              </button>

              <!-- ÏòàÍ≥†Ìé∏ Î≤ÑÌäº -->
              <button @click="toggleTrailer" class="trailer-btn">
                <span class="play-icon">{{ showTrailer ? "‚úï" : "‚ñ∂" }}</span>
                {{ showTrailer ? "Close Trailer" : "Watch Trailer" }}
              </button>
            </div>
          </div>
        </div>

        <!-- ÏòÅÌôî ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ÏÑπÏÖò -->
        <div v-if="showDetails" class="movie-details-section">
          <div class="details-grid">
            <div class="detail-item">
              <span class="detail-label">Director</span>
              <span class="detail-value">{{ movieDetail.director }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Runtime</span>
              <span class="detail-value">{{ movieDetail.runtime }} minutes</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Rating</span>
              <span class="detail-badge">{{ convertedRating }}</span>
            </div>
          </div>
          <div class="cast-section">
            <span class="detail-label">Cast</span>
            <div class="cast-members">
              <div v-for="actor in movieDetail.cast" :key="actor.name" class="cast-member">
                <span class="actor-name">{{ actor.name }}</span>
                <span class="actor-character">as {{ actor.character }}</span>
              </div>
            </div>
          </div>
        </div>


        <!-- Ìä∏Î†àÏùºÎü¨ ÏÑπÏÖò (ÌÜ†Í∏Ä) -->
        <div v-if="showTrailer" class="trailer-section">
          <iframe width="100%" height="500" :src="`https://www.youtube.com/embed/${movieDetail.youtube_trailer_id}`"
            frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen></iframe>
        </div>
      </div>

      <!-- Ïä§ÌÅ¨Î¶ΩÌä∏ Î∂ÑÏÑù ÏÑπÏÖò 
Îç∞Ïù¥ÌÑ∞ ÌùêÎ¶Ñ Î∞è Íµ¨Ï°∞:
1. Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏàúÏÑú:
  - MovieList: Ïó¨Îü¨ ÏòÅÌôîÏùò Í∏∞Î≥∏ Ï†ïÎ≥¥Îßå ÏÑúÎ≤ÑÏóê Ï†ÄÏû•
  - MovieDetail: ÏÑ†ÌÉùÎêú ÏòÅÌôîÏùò ÏÉÅÏÑ∏ Ï†ïÎ≥¥Îßå ÏöîÏ≤≠
  - onMounted -> fetchMovieDetail -> movieDetail Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
  - computed ÏÜçÏÑ±Ïù∏ paginatedScriptsÍ∞Ä ÏûêÎèô Í≥ÑÏÇ∞ÎêòÏñ¥ Ï¥àÍ∏∞ ÌôîÎ©¥ Î†åÎçîÎßÅ

2. paginatedScripts (computed ÏÜçÏÑ±):
  - movieDetail Î≥ÄÍ≤Ω Ïãú ÏûêÎèô Ïû¨Í≥ÑÏÇ∞
  - itemsPerPage(5Í∞ú)ÎßåÌÅº Ïä§ÌÅ¨Î¶ΩÌä∏ Î∂ÑÌï†ÌïòÏó¨ ÌëúÏãú
  - Object.entries()Î°ú Í∞ùÏ≤¥Î•º Î∞∞Ïó¥Î°ú Î≥ÄÌôò ÌõÑ sliceÎ°ú ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
  - Object.fromEntries()Î°ú Îã§Ïãú Î∞∞Ïó¥ÏùÑ Í∞ùÏ≤¥Î°ú Î≥ÄÌôòÌïòÏó¨ Íµ¨Ï°∞ Ïú†ÏßÄ
  
3. Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏòàÏãú:
  paginatedScripts = {
    "Hello": {                // script Í∞í
      timestamp: "00:01:23",  // data.timestamp
      words: [               // data.words
        { id: 1, word: "Hello" },
        { id: 2, word: "World" }
      ],
      highest_match_rate: 85  // Î∞úÏùå ÌèâÍ∞Ä ÏµúÍ≥† Ï†êÏàò
    }
  }

4. ÏïàÏ†ÑÌïú Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º:
  - movieDetail.value?.filtered_scriptsÎ°ú ÏòµÏÖîÎÑê Ï≤¥Ïù¥Îãù ÏÇ¨Ïö©
  - Îç∞Ïù¥ÌÑ∞ ÏóÜÏúºÎ©¥ Îπà Í∞ùÏ≤¥({}) Î∞òÌôòÌïòÏó¨ ÏóêÎü¨ Î∞©ÏßÄ -->

      <div class="script-analysis-section">
        <h2 class="section-title">Script Analysis</h2>
        <div class="scripts-container">
          <!-- Ïä§ÌÅ¨Î¶ΩÌä∏ Î∞òÎ≥µ Î†åÎçîÎßÅ:
   1. v-forÎ°ú ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏùò Ïä§ÌÅ¨Î¶ΩÌä∏Îßå Î†åÎçîÎßÅ
   2. Í∞Å Ïä§ÌÅ¨Î¶ΩÌä∏Îäî ÎèÖÎ¶ΩÏ†ÅÏù∏:
      - ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
      - GPT Î∂ÑÏÑù ÏÉÅÌÉú
      - ÎÖπÏùå/Ïû¨ÏÉù Í∏∞Îä•
      - Î∞úÏùå ÌèâÍ∞Ä Í≤∞Í≥ºÎ•º Í∞ÄÏßê
   3. key ÏÜçÏÑ±ÏúºÎ°ú VueÏùò Í∞ÄÏÉÅ DOM ÏµúÏ†ÅÌôî -->
          <div v-for="(data, script) in paginatedScripts" :key="script" class="script-card">
            <!-- Ïä§ÌÅ¨Î¶ΩÌä∏ Ìó§Îçî ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏:
     1. Ïù¥ÎØ∏ Î∂ÑÏÑùÎêú Í≤ΩÏö∞:
        - analyzedScripts[script] Ï≤¥ÌÅ¨
        - gptOutputDisplay[script] ÌÜ†Í∏ÄÎ°ú Í≤∞Í≥º ÌëúÏãú/Ïà®ÍπÄ
     2. ÏÉàÎ°úÏö¥ Î∂ÑÏÑù ÌïÑÏöî:
        - loading ÏÉÅÌÉú ÌëúÏãú
        - axiosÎ°ú GPT Î∂ÑÏÑù ÏöîÏ≤≠
        - typeTextÎ°ú Í≤∞Í≥º Ïï†ÎãàÎ©îÏù¥ÏÖò ÌëúÏãú
        - analyzedScriptsÏóê Î∂ÑÏÑù ÏôÑÎ£å ÌëúÏãú -->
            <div class="script-header" @click="handleScriptClick($event, script, data)">
              <div class="script-content">
                <!-- script: Ïã§Ï†ú ÎåÄÏÇ¨ ÌÖçÏä§Ìä∏ (Ï¥àÍ∏∞ Î°úÎìú Îç∞Ïù¥ÌÑ∞) -->
                <p class="script-text">{{ script }}</p>
                <!-- timestamp: ÏòÅÌôî ÎÇ¥ Ìï¥Îãπ ÎåÄÏÇ¨ ÏãúÏ†ê -->
                <span class="timestamp">Time: {{ data.timestamp }}</span>
              </div>

              <!-- Î∞úÏùå ÌèâÍ∞Ä Î±ÉÏßÄ (Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ÅÏö©):
       highest_match_rate Í∏∞Ï§Ä:
       - 100%: Í≥®Îìú Î±ÉÏßÄ, 5Ï†ê
       - 80% Ïù¥ÏÉÅ: Ïã§Î≤Ñ Î±ÉÏßÄ, 3Ï†ê
       - 60% Ïù¥ÏÉÅ: Î∏åÎ°†Ï¶à Î±ÉÏßÄ, 1Ï†ê -->
              <transition name="badge-fade">
                <!-- 100 ÌçºÏÑºÌä∏ Ïùº Îïå -->
                <span v-if="data.highest_match_rate === 100" class="achievement-badge gold">
                  <i class="fas fa-trophy"></i> Perfect! (5 points)
                </span>
                <!-- 80Ìçº Ïù¥ÏÉÅ -->
                <span v-else-if="data.highest_match_rate >= 80" class="achievement-badge silver">
                  <i class="fas fa-award"></i> Great! (3 points)
                </span>
                <!-- 60Ìçº Ïù¥ÏÉÅ -->
                <span v-else-if="data.highest_match_rate >= 60" class="achievement-badge bronze">
                  <i class="fas fa-award"></i> Good! (1 points)
                </span>
              </transition>
            </div>

            <div class="word-list">
              <h4 class="word-list-title">Key Words</h4>
              <div class="words">
                <!-- Îã®Ïñ¥ Î≤ÑÌäº -->
                <button v-for="word in data.words" :key="word.id" @click="addToFavoriteVoca(word.id)" class="word-chip">
                  {{ word.word }}
                  <span class="popup-message" :class="{ show: wordPopups[word.id] }">
                    {{ wordPopupMessages[word.id] }}
                    <span class="popup-emoji">{{ wordPopupEmojis[word.id] }}</span>
                  </span>
                </button>
              </div>
            </div>

            <!-- ÎÖπÏùå ÏòÅÏó≠ -->
            <div class="recording-section">
              <div class="record-area">
                <h4>Speech Practice</h4>
                <div class="controls">
                  <button @click="toggleRecording(script, data.script_id)" :class="{ 'recording': isRecording[script] }"
                    class="record-button">
                    <span class="record-icon">üé§</span>
                    {{ isRecording[script] ? 'Stop Recording' : 'Start Recording' }}
                  </button>

                  <div v-if="recordedAudio[script]" class="audio-controls">
                    <audio :src="recordedAudio[script]?.url" controls></audio>
                    <button @click="convertToText(script, data.script_id)" :disabled="isConverting[script]"
                      class="submit-button">
                      Check Pronunciation
                    </button>
                  </div>
                </div>

                <!-- Í≤∞Í≥º ÌëúÏãú -->
                <div v-if="practiceResults[script]" class="result-section">
                  <div class="result-header">
                    <h4>Your Result:</h4>
                    <div class="badges">
                      <span class="match-badge" :class="getMatchRateClass(practiceResults[script].match_rate)">
                        {{ practiceResults[script].match_rate.toFixed(2) }}% Match
                      </span>
                      <span v-if="practiceResults[script].is_new_record" class="new-record-badge">
                        You've gained {{ practiceResults[script].points }} points!
                      </span>
                    </div>
                  </div>
                  <div class="speech-comparison">
                    <div class="original-text">
                      <p class="label">Original:</p>
                      <p class="text">{{ script }}</p>
                    </div>
                    <div class="your-speech">
                      <p class="label">Your Speech:</p>
                      <p class="text">{{ practiceResults[script].text }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- gpt Í≤∞Í≥º -->
            <div class="gpt-output" :class="{ active: gptOutputDisplay[script] }" v-show="gptOutputDisplay[script]">
              <div class="loading" v-if="loadingDisplay[script]">
                <div class="loading-spinner"></div>
                Analyzing...
              </div>
              <div class="content" :data-content="`content-${script.replace(/\s+/g, '-')}`"></div>
            </div>
          </div>

          <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
          <div class="pagination">
            <button @click="handlePrevGroup" :disabled="currentPageGroup === 1" class="pagination-btn">Previous</button>
            <div class="page-numbers">
              <button v-for="pageNum in displayedPages" :key="pageNum" @click="currentPage = pageNum"
                class="page-number" :class="{ active: currentPage === pageNum }">
                {{ pageNum }}
              </button>
            </div>
            <button @click="handleNextGroup" :disabled="currentPageGroup >= maxPageGroup"
              class="pagination-btn">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed, watch } from "vue";
import { useRoute } from "vue-router";
import axios from "axios";
import { useAuthStore } from "@/stores/auth";
import { storeToRefs } from "pinia";
// ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò ÏÉÅÌÉú
const currentPage = ref(1);
const itemsPerPage = 5;
const pagesPerGroup = 5;

// Ï∞úÌïòÍ∏∞ Í¥ÄÎ†® ÏÉÅÌÉú
const showFavPopup = ref(false);
const favPopupMessage = ref("");

// Îã®Ïñ¥Ïû• Í¥ÄÎ†® ÏÉÅÌÉú
const wordPopups = ref({});
const wordPopupMessages = ref({});
const wordPopupEmojis = ref({});

const showTrailer = ref(false);
const route = useRoute();
const movieDetail = ref(null);
const analyzedScripts = ref({});
const gptOutputDisplay = ref({});
const loadingDisplay = ref({});
const words = ref([]);
const showDetails = ref(false)

const authStore = useAuthStore();
const isFavorite = ref(false);
const { token, isLogin } = storeToRefs(authStore);

// ÎÖπÏùåÍ¥ÄÎ†® ÏÉÅÌÉú
const isRecording = ref({});
const recordedAudio = ref({});
const practiceResults = ref({});
const mediaRecorder = ref(null);
const isConverting = ref({});

// ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌÜ†Í∏Ä Ìï®Ïàò
const toggleMovieDetails = () => {
  showDetails.value = !showDetails.value;
};

// ÏòÅÌôî Îì±Í∏â
const convertedRating = computed(() => {
  const usRating = movieDetail.value?.rating?.toUpperCase();

  switch (usRating) {
    case 'G':
      return 'Ï†ÑÏ≤¥ Í¥ÄÎûåÍ∞Ä'
    case 'PG':
    case 'PG-13':
      return '12ÏÑ∏ Ïù¥ÏÉÅ Í¥ÄÎûåÍ∞Ä'
    case 'R':
      return '15ÏÑ∏ Ïù¥ÏÉÅ Í¥ÄÎûåÍ∞Ä'
    case 'NC-17':
      return 'Ï≤≠ÏÜåÎÖÑ Í¥ÄÎûåÎ∂àÍ∞Ä'
    case 'NR':
    case 'UNRATED':
      return 'ÎØ∏Î∂ÑÎ•ò'
    default:
      return 'Îì±Í∏â Ï†ïÎ≥¥ ÏóÜÏùå'
  }
})


// ÎÖπÏùå ÌÜ†Í∏Ä Ìï®Ïàò
const toggleRecording = async (script, scriptId) => {
  if (isRecording.value[script]) {
    stopRecording(script);
  } else {
    startRecording(script);
  }
};

// ÎÖπÏùå ÏãúÏûë Ìï®Ïàò
const startRecording = async (script) => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        sampleRate: 48000,
        channelCount: 1,
        echoCancellation: true,
        noiseSuppression: true,
      }
    });

    mediaRecorder.value = new MediaRecorder(stream, {
      mimeType: 'audio/webm;codecs=opus'
    });

    const chunks = [];

    mediaRecorder.value.ondataavailable = (e) => {
      if (e.data.size > 0) chunks.push(e.data);
    };

    mediaRecorder.value.onstop = () => {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      recordedAudio.value[script] = {
        url: URL.createObjectURL(blob),
        blob: blob
      };
      stream.getTracks().forEach(track => track.stop());
    };

    mediaRecorder.value.start();
    isRecording.value[script] = true;
  } catch (err) {
    console.error('Error accessing microphone:', err);
    alert('ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
  }
};

// ÎÖπÏùå Ï§ëÏßÄ Ìï®Ïàò
const stopRecording = (script) => {
  if (mediaRecorder.value?.state === 'recording') {
    mediaRecorder.value.stop();
    isRecording.value[script] = false;
  }
};

// ÌÖçÏä§Ìä∏ Î≥ÄÌôò Ìï®Ïàò
const convertToText = async (script, scriptId) => {
  try {
    isConverting.value[script] = true;
    const audioData = recordedAudio.value[script];

    if (!audioData?.blob) {
      throw new Error('ÎÖπÏùåÎêú Ïò§ÎîîÏò§Í∞Ä ÏóÜÏäµÎãàÎã§.');
    }

    const formData = new FormData();
    formData.append('audio', audioData.blob, 'recording.webm');
    formData.append('original_script', script);
    formData.append('script_id', scriptId);

    const auth = JSON.parse(localStorage.getItem("auth"));
    const response = await axios.post(
      'http://localhost:8000/movie/convert-speech/',
      formData,
      {
        headers: {
          Authorization: `Token ${auth.token}`,
          'Content-Type': 'multipart/form-data',
        }
      }
    );

    practiceResults.value[script] = {
      text: response.data.text,
      match_rate: response.data.match_rate,
      is_new_record: response.data.is_new_record,
      points: response.data.points
    };
    // ÏÉàÎ°úÏö¥ ÏµúÍ≥† Í∏∞Î°ùÏùº Í≤ΩÏö∞ highest_match_rate ÏóÖÎç∞Ïù¥Ìä∏
    if (paginatedScripts.value[script] && response.data.is_new_record) {
      paginatedScripts.value[script].highest_match_rate = response.data.match_rate;
    }

  } catch (error) {
    console.error('STT conversion error:', error);
    alert(error.message || 'ÏùåÏÑ± Î≥ÄÌôò Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
  } finally {
    isConverting.value[script] = false;
  }
};

// ÏùºÏπòÏú®Ïóê Îî∞Î•∏ ÌÅ¥ÎûòÏä§ Î∞òÌôò
const getMatchRateClass = (rate) => {
  if (rate >= 90) return 'excellent';
  if (rate >= 70) return 'good';
  return 'needs-improvement';
};


const toggleTrailer = () => {
  showTrailer.value = !showTrailer.value;
};

const props = defineProps({
  movieId: String,
  movieTitle: String,
});

// ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌï¥ props Í∞í ÌôïÏù∏
console.log("Props:", props.movieId, props.movieTitle);


// Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ Ïàò Í≥ÑÏÇ∞
const totalPages = computed(() => {
  if (!movieDetail.value?.filtered_scripts) return 1;
  return Math.ceil(Object.keys(movieDetail.value.filtered_scripts).length / itemsPerPage);
});

// ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Í∑∏Î£π
const currentPageGroup = computed(() => {
  return Math.ceil(currentPage.value / pagesPerGroup);
});

// ÏµúÎåÄ ÌéòÏù¥ÏßÄ Í∑∏Î£π
const maxPageGroup = computed(() => {
  return Math.ceil(totalPages.value / pagesPerGroup);
});

// ÌôîÎ©¥Ïóê ÌëúÏãúÌï† ÌéòÏù¥ÏßÄ Î≤àÌò∏Îì§
const displayedPages = computed(() => {
  const start = (currentPageGroup.value - 1) * pagesPerGroup + 1;
  const end = Math.min(start + pagesPerGroup - 1, totalPages.value);
  return Array.from({ length: end - start + 1 }, (_, i) => start + i);
});

// ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê ÌëúÏãúÌï† Ïä§ÌÅ¨Î¶ΩÌä∏Îì§
const paginatedScripts = computed(() => {
  if (!movieDetail.value?.filtered_scripts) return {};

  const scripts = Object.entries(movieDetail.value.filtered_scripts);
  const start = (currentPage.value - 1) * itemsPerPage;
  const end = start + itemsPerPage;

  return Object.fromEntries(scripts.slice(start, end));
});

// Ïù¥Ï†Ñ Í∑∏Î£πÏúºÎ°ú Ïù¥Îèô
const handlePrevGroup = () => {
  const newPage = Math.max(1, (currentPageGroup.value - 1) * pagesPerGroup);
  currentPage.value = newPage;
};

// Îã§Ïùå Í∑∏Î£πÏúºÎ°ú Ïù¥Îèô
const handleNextGroup = () => {
  const newPage = Math.min(totalPages.value, currentPageGroup.value * pagesPerGroup + 1);
  currentPage.value = newPage;
};
const typeText = (element, text, speed = 25) => {
  let index = 0;
  element.innerHTML = "";

  const addChar = () => {
    if (index < text.length) {
      if (text.slice(index).startsWith("\n")) {
        element.innerHTML += "<br>";
        index++;
      } else {
        // HTML ÌÉúÍ∑∏ Ï≤òÎ¶¨
        if (text.slice(index).startsWith("<")) {
          const closingIndex = text.indexOf(">", index) + 1;
          if (closingIndex > index) {
            element.innerHTML += text.slice(index, closingIndex);
            index = closingIndex;
            setTimeout(addChar, 0); // ÌÉúÍ∑∏Îäî Ï¶âÏãú Ï∂îÍ∞Ä
            return;
          }
        }
        element.innerHTML += text[index];
        index++;
      }
      setTimeout(addChar, speed);
    }
  };

  addChar();
};

// Îã®Ïñ¥ Ï∂îÍ∞Ä Ìï®Ïàò
const addToFavoriteVoca = async (wordId) => {
  const auth = JSON.parse(localStorage.getItem("auth"));
  const token = auth?.token;

  if (!token) {
    alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
    return;
  }

  try {
    const response = await axios({
      method: "post",
      url: "http://localhost:8000/movie/add_to_favorite_voca/",
      data: { word_id: wordId },
      headers: {
        Authorization: `Token ${token}`,
        "Content-Type": "application/json",
      },
    });

    // ÏùëÎãµÏóê Îî∞Îùº Îã§Î•∏ Î©îÏãúÏßÄÏôÄ Ïù¥Î™®ÏßÄ ÏÑ§Ï†ï
    wordPopupMessages.value[wordId] = response.data.message === "Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú Îã®Ïñ¥ÏûÖÎãàÎã§." ? "Already in vocabulary!" : "Added to vocabulary!";
    wordPopupEmojis.value[wordId] = response.data.message === "Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêú Îã®Ïñ¥ÏûÖÎãàÎã§." ? "üìù" : "‚ú®";

    // ÌåùÏóÖ ÌëúÏãú Î∞è ÏûêÎèô Ïà®ÍπÄ
    wordPopups.value[wordId] = true;
    setTimeout(() => {
      wordPopups.value[wordId] = false;
    }, 2000);
  } catch (error) {
    console.error("Error:", error);
  }
};

// Vue Ïª¥Ìè¨ÎÑåÌä∏Ïùò script setupÏóêÏÑú Ïã§ÌñâÎêòÎäî ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ Ìï®Ïàò
// async/await ÏÇ¨Ïö©ÏúºÎ°ú ÎπÑÎèôÍ∏∞ Ï≤òÎ¶¨
// event: ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Í∞ùÏ≤¥
// script: Î∂ÑÏÑùÌï† Ïä§ÌÅ¨Î¶ΩÌä∏ ÌÖçÏä§Ìä∏
// data: Ïä§ÌÅ¨Î¶ΩÌä∏ Í¥ÄÎ†® Ï†ïÎ≥¥Î•º Îã¥ÏùÄ Í∞ùÏ≤¥
// ÌÖúÌîåÎ¶øÏóêÏÑú @click="handleScriptClick($event, script, data)" ÌòïÌÉúÎ°ú Ìò∏Ï∂úÎê®
const handleScriptClick = async (event, script, data) => {
  // analyzedScripts.value[script]: Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Ïù¥ÎØ∏ Î∂ÑÏÑùÎêòÏóàÎäîÏßÄ Ïó¨Î∂ÄÎ•º Ï†ÄÏû•ÌïòÎäî Í∞ùÏ≤¥
  // value[script]ÏóêÏÑú scriptÎäî keyÍ∞íÏúºÎ°ú, Ìï¥Îãπ Ïä§ÌÅ¨Î¶ΩÌä∏ ÌÖçÏä§Ìä∏Í∞Ä Îì§Ïñ¥Í∞ê
  // valueÎäî VueÏùò ref()Î°ú ÏÉùÏÑ±Îêú Î∞òÏùëÌòï Í∞ùÏ≤¥Ïùò Ïã§Ï†ú Í∞íÏóê Ï†ëÍ∑ºÌïòÍ∏∞ ÏúÑÌïú ÏÜçÏÑ±
  // ref()Î°ú ÏÉùÏÑ±Îêú Í∞ùÏ≤¥Îäî .valueÎ°ú Ïã§Ï†ú Í∞íÏóê Ï†ëÍ∑ºÌï¥Ïïº Ìï®
  // .valueÍ∞Ä ÏóÜÏúºÎ©¥ Proxy Í∞ùÏ≤¥Í∞Ä Î∞òÌôòÎêòÏñ¥ Ïã§Ï†ú Í∞í Ï†ëÍ∑º Î∂àÍ∞Ä
  if (analyzedScripts.value[script]) {
    // Ïù¥ÎØ∏ Î∂ÑÏÑùÎêú Ïä§ÌÅ¨Î¶ΩÌä∏ÎùºÎ©¥ Í≤∞Í≥º ÌëúÏãúÎ•º ÌÜ†Í∏Ä
    // gptOutputDisplayÎäî Î∂ÑÏÑù Í≤∞Í≥ºÏùò ÌôîÎ©¥ ÌëúÏãú Ïó¨Î∂ÄÎ•º Ï†úÏñ¥ÌïòÎäî VueÏùò Î∞òÏùëÌòï Í∞ùÏ≤¥
    // trueÎ©¥ Í≤∞Í≥º ÌëúÏãú, falseÎ©¥ Í≤∞Í≥º Ïà®ÍπÄ
    // ÌôîÎ©¥ÏóêÏÑúÎäî v-show ÎîîÎ†âÌã∞Î∏åÎ°ú Ïù¥ Í∞íÏóê Îî∞Îùº ÌëúÏãú/Ïà®ÍπÄ Ï≤òÎ¶¨
    // v-showÎäî display: none/blockÏúºÎ°ú ÌôîÎ©¥ ÌëúÏãúÎ•º Ï†úÏñ¥
    // v-showÏôÄ Îã¨Î¶¨ v-ifÎäî DOMÏóêÏÑú ÏöîÏÜåÎ•º ÏôÑÏ†ÑÌûà Ï†úÍ±∞/Ï∂îÍ∞Ä
    gptOutputDisplay.value[script] = !gptOutputDisplay.value[script];
    return;
  }

  // Ï≤´ Î∂ÑÏÑù ÏãúÏóêÎäî Í≤∞Í≥º ÌëúÏãú ÏÑ§Ï†ïÏùÑ trueÎ°ú,
  // gptOutputDisplayÏùò Ï¥àÍ∏∞Í∞íÏùÄ falseÏù¥Î©∞, Ïä§ÌÅ¨Î¶ΩÌä∏Î≥ÑÎ°ú Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨Îê®
  // key(script)-value(boolean) ÌòïÌÉúÎ°ú Ï†ÄÏû•
  // VueÏùò Î∞òÏùëÌòï ÏãúÏä§ÌÖúÏù¥ Ïù¥ Í∞íÏùò Î≥ÄÌôîÎ•º Í∞êÏßÄÌïòÏó¨ ÌôîÎ©¥ÏùÑ ÏûêÎèôÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
  gptOutputDisplay.value[script] = true;
  // Î°úÎî© ÌëúÏãúÎèÑ trueÎ°ú ÏÑ§Ï†ï
  // loadingDisplayÎèÑ Ïä§ÌÅ¨Î¶ΩÌä∏Î≥ÑÎ°ú Î°úÎî© ÏÉÅÌÉúÎ•º Í∞úÎ≥Ñ Í¥ÄÎ¶¨
  // Î∂ÑÏÑùÏù¥ ÏôÑÎ£åÎêòÎ©¥ finally Î∏îÎ°ùÏóêÏÑú falseÎ°ú Î≥ÄÍ≤ΩÎê®
  loadingDisplay.value[script] = true;

  try {
    // localStorage: Î∏åÎùºÏö∞Ï†Ä Ï†úÍ≥µ Ïõπ Ïä§ÌÜ†Î¶¨ÏßÄ API, ÎèÑÎ©îÏù∏Î≥ÑÎ°ú 5~10MB Ï†ÄÏû• Í∞ÄÎä•
    // getItem: localStorageÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§Îäî Î©îÏÑúÎìú
    // JSON.parse: Î¨∏ÏûêÏó¥Î°ú Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î•º JavaScript Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
    // localStorageÎäî Î¨∏ÏûêÏó¥Îßå Ï†ÄÏû• Í∞ÄÎä•ÌïòÎØÄÎ°ú, Í∞ùÏ≤¥Îäî JSON.stringify()Î°ú Ï†ÄÏû•ÌïòÍ≥†
    // Í∞ÄÏ†∏Ïò¨ ÎïåÎäî JSON.parse()Î°ú Îã§Ïãú Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
    // localStorageÎäî Î∏åÎùºÏö∞Ï†ÄÎ•º Îã´ÏïÑÎèÑ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïú†ÏßÄÎêòÎ©∞, ÎèÑÎ©îÏù∏Î≥ÑÎ°ú ÎèÖÎ¶ΩÏ†ÅÏù∏ Ï†ÄÏû•ÏÜåÎ•º Í∞ÄÏßê
    // sessionStorageÎäî ÌÉ≠ÏùÑ Îã´ÏúºÎ©¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêúÎã§Îäî Ï†êÏù¥ Îã§Î¶Ñ
    // localStorage Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò ÌååÏã± Ïã§Ìå® Ïãú ÏóêÎü¨ Ï≤òÎ¶¨ ÌïÑÏöî
    const auth = JSON.parse(localStorage.getItem("auth"));
    // ÏòµÏÖîÎÑê Ï≤¥Ïù¥Îãù(?.)ÏúºÎ°ú authÍ∞Ä null/undefinedÏó¨ÎèÑ ÏóêÎü¨ ÏóÜÏù¥ Ï≤òÎ¶¨
    // auth Í∞ùÏ≤¥Í∞Ä ÏóÜÏúºÎ©¥ undefined Î∞òÌôò
    // ÏòµÏÖîÎÑê Ï≤¥Ïù¥ÎãùÏù¥ ÏóÜÏúºÎ©¥ authÍ∞Ä nullÏùº Îïå ÏóêÎü¨ Î∞úÏÉù
    // ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏúºÎ©¥ Î°úÍ∑∏Ïù∏ ÌïÑÏöî ÏïåÎ¶º Ï≤òÎ¶¨ ÌïÑÏöî
    const token = auth?.token;

    // axiosÎ°ú ÏÑúÎ≤ÑÏóê POST ÏöîÏ≤≠
    // POST ÏÇ¨Ïö© Ïù¥Ïú†: 
    // 1. Î≥µÏû°Ìïú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ° Í∞ÄÎä• (bodyÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°)
    // 2. URL Í∏∏Ïù¥ Ï†úÌïú ÏóÜÏùå
    // 3. Î≥¥Ïïà (Îç∞Ïù¥ÌÑ∞Í∞Ä URLÏóê ÎÖ∏Ï∂úÎêòÏßÄ ÏïäÏùå)
    // 4. ÏÑúÎ≤ÑÏóêÏÑú ÏÉàÎ°úÏö¥ Î∂ÑÏÑù Í≤∞Í≥º ÏÉùÏÑ±
    // 5. ÏÇ¨Ïö©ÏûêÎ≥Ñ ÌïôÏäµ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Í∞ÄÎä•
    // GET ÏöîÏ≤≠ÏùÄ Îç∞Ïù¥ÌÑ∞Í∞Ä URLÏóê ÎÖ∏Ï∂úÎêòÏñ¥ Î≥¥ÏïàÏóê Ï∑®ÏïΩÌïòÍ≥† Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞ Ï†úÌïúÏù¥ ÏûàÏùå
    const response = await axios.post(
      // Í∞úÎ∞ú ÌôòÍ≤ΩÏùò URL. Î∞∞Ìè¨ ÏãúÏóêÎäî Ïã§Ï†ú ÎèÑÎ©îÏù∏ÏúºÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî
      // ÌôòÍ≤ΩÎ≥ÄÏàò(.env)Î•º ÏÇ¨Ïö©ÌïòÏó¨ Í¥ÄÎ¶¨ÌïòÎäî Í≤ÉÏù¥ Ï¢ãÏùå
      // VITE_API_URL=http://localhost:8000 ÌòïÏãùÏúºÎ°ú Ï†ÄÏû•
      // Ïã§Ï†ú Î∞∞Ìè¨ Ïãú: VITE_API_URL=https://your-domain.com
      // ${import.meta.env.VITE_API_URL}Î°ú ÌôòÍ≤ΩÎ≥ÄÏàò ÏÇ¨Ïö©
      // ÌôòÍ≤Ω Î≥ÄÏàò Ïù¥Î¶ÑÏùÄ Î∞òÎìúÏãú VITE_Î°ú ÏãúÏûëÌï¥Ïïº Ìï®
      // Django ÏÑúÎ≤ÑÏùò Î∂ÑÏÑù ÏóîÎìúÌè¨Ïù∏Ìä∏
      // Django urls.pyÏóêÏÑú Ï†ïÏùòÎêú URLÍ≥º Îß§Ïπ≠
      // REST API ÏÑ§Í≥Ñ Í∑úÏπô: POSTÎäî ÏÉà Î¶¨ÏÜåÏä§ ÏÉùÏÑ±
      // Ï°∞ÌöåÎßå ÌïòÎäî Í≤ΩÏö∞ÏóêÎèÑ Îç∞Ïù¥ÌÑ∞Í∞Ä ÌÅ¨Í±∞ÎÇò Î≥¥ÏïàÏù¥ ÌïÑÏöîÌïòÎ©¥ POST ÏÇ¨Ïö©
      "http://localhost:8000/movie/analyze_script/",
      {
        // request body
        // request body Îç∞Ïù¥ÌÑ∞Îäî DjangoÏóêÏÑú request.dataÎ°ú Ï†ëÍ∑º
        // request.dataÎäî ÏûêÎèôÏúºÎ°ú JSON ÌååÏã±
        script: script,  // Î∂ÑÏÑùÌï† Ïä§ÌÅ¨Î¶ΩÌä∏ ÌÖçÏä§Ìä∏
        // data Í∞ùÏ≤¥Îäî v-for="(data, script) in paginatedScripts"ÏóêÏÑú Ï†ÑÎã¨Îê®
        // data.wordsÎäî Ìï¥Îãπ Ïä§ÌÅ¨Î¶ΩÌä∏Ïùò Îã®Ïñ¥ Î∞∞Ïó¥ 
        // Î∞∞Ïó¥ ÌòïÌÉú: [{ id: 1, word: "hello", meaning: "ÏïàÎÖï" }, ...]
        // Îã®Ïùº Í∞íÎì§(timestamp, script_id Îì±)ÏùÄ Î¨∏ÏûêÏó¥Ïù¥ÎÇò Ïà´ÏûêÎ°ú Ï†ÄÏû•
        // data Í∞ùÏ≤¥ÏóêÎäî words Ïô∏ÏóêÎèÑ timestamp, script_id Îì±Ïùò Ï†ïÎ≥¥Í∞Ä ÏûàÏùå
        // scriptÏôÄ wordsÎßå Ï†ÑÏÜ°ÌïòÎØÄÎ°ú ÌïÑÏöîÌïú ÏµúÏÜåÌïúÏùò Îç∞Ïù¥ÌÑ∞Îßå Ï†ÑÏÜ°
        words: data.words,
      },
      {
        // request headers: HTTP ÏöîÏ≤≠Ïùò Î©îÌÉÄ Ï†ïÎ≥¥
        headers: {
          // ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ùÏùÑ ÏúÑÌïú ÌÜ†ÌÅ∞
          // DjangoÏóêÏÑúÎäî request.META.get('HTTP_AUTHORIZATION')ÏúºÎ°ú Ï†ëÍ∑º
          // DjangoÏùò request.data['script']Î°ú body Îç∞Ïù¥ÌÑ∞ Ï†ëÍ∑º
          // request.dataÎäî Django REST FrameworkÏóêÏÑú Ï†úÍ≥µÌïòÎäî ÌååÏã±Îêú ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞
          // ÌÜ†ÌÅ∞ÏúºÎ°ú ÏÇ¨Ïö©Ïûê ÏãùÎ≥Ñ ÌõÑ Í∞úÏù∏ÌôîÎêú Î∂ÑÏÑù Í≤∞Í≥º Ï†úÍ≥µ Í∞ÄÎä•
          // ÌÜ†ÌÅ∞ Ïù∏Ï¶ù Î∞©ÏãùÏúºÎ°ú ÏÇ¨Ïö©Ïûê ÏãùÎ≥Ñ
          // ÌÜ†ÌÅ∞ÏùÄ Î°úÍ∑∏Ïù∏ Ïãú ÏÑúÎ≤ÑÍ∞Ä Î∞úÍ∏â
          // Ïù¥ÌõÑ Î™®Îì† API ÏöîÏ≤≠Ïóê ÌÜ†ÌÅ∞ Ìè¨Ìï®
          // Î∞±ÏóîÎìúÏóêÏÑúÎäî ÌÜ†ÌÅ∞ÏúºÎ°ú ÏÇ¨Ïö©Ïûê Ï°∞Ìöå ÌõÑ
          // ÏÇ¨Ïö©ÏûêÏùò ÌïôÏäµ ÏàòÏ§Ä, ÌïôÏäµ Ïù¥Î†• Îì±ÏùÑ Í≥†Î†§Ìïú ÎßûÏ∂§Ìòï Î∂ÑÏÑù Ï†úÍ≥µ
          Authorization: `Token ${token}`,
        },
      }
    );

    // ÏùëÎãµ Ï≤òÎ¶¨
    // contentKeyÎäî Ïä§ÌÅ¨Î¶ΩÌä∏ ÌÖçÏä§Ìä∏ÏóêÏÑú Í≥µÎ∞±ÏùÑ '-'Î°ú Î≥ÄÌôòÌïòÏó¨ ÏÉùÏÑ±
    // Ïù¥Îäî DOM ÏöîÏÜåÎ•º Ï∞æÍ∏∞ ÏúÑÌïú ÏãùÎ≥ÑÏûêÎ°ú ÏÇ¨Ïö©
    // HTMLÏóêÏÑúÎäî <div class="content" :data-content="`content-${script.replace(/\s+/g, '-')}`">
    // ÌòïÌÉúÎ°ú Îß§Ïπ≠ÎêòÎäî ÏöîÏÜåÍ∞Ä ÏûàÏñ¥Ïïº Ìï®
    const contentKey = `content-${script.replace(/\s+/g, "-")}`;
    const contentElement = document.querySelector(`[data-content="${contentKey}"]`);

    if (contentElement) {
      // typeTextÎäî Î≥ÑÎèÑÎ°ú Ï†ïÏùòÎêú Ìï®ÏàòÎ°ú, ÌÖçÏä§Ìä∏Î•º Ìïú Í∏ÄÏûêÏî© ÌÉÄÏù¥ÌïëÌïòÎäî Ìö®Í≥º Íµ¨ÌòÑ
      // speed Îß§Í∞úÎ≥ÄÏàòÎ°ú ÌÉÄÏù¥Ìïë ÏÜçÎèÑ Ï°∞Ï†à Í∞ÄÎä•
      typeText(contentElement, response.data.response);
      // Î∂ÑÏÑù ÏôÑÎ£å ÌëúÏãú (Ïû¨Î∂ÑÏÑù Î∞©ÏßÄ)
      analyzedScripts.value[script] = true;
    }

  } catch (error) {
    // ÏóêÎü¨ Î∞úÏÉù Ïãú ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†ÅÏù∏ ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
    // class="error"Î°ú Ïä§ÌÉÄÏùºÎßÅ Í∞ÄÎä•
    const contentKey = `content-${script.replace(/\s+/g, "-")}`;
    const contentElement = document.querySelector(`[data-content="${contentKey}"]`);
    if (contentElement) {
      contentElement.innerHTML = '<p class="error">Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
    }
    // Í∞úÎ∞úÏûê ÎèÑÍµ¨ ÏΩòÏÜîÏóê ÏûêÏÑ∏Ìïú ÏóêÎü¨ Ï†ïÎ≥¥ Í∏∞Î°ù
    console.error("Analysis error:", error);
  } finally {
    // Î°úÎî© ÏÉÅÌÉú Ìï¥Ï†ú
    // ÌÖúÌîåÎ¶øÏóêÏÑú v-if="loadingDisplay[script]"Î°ú Î°úÎî© ÌëúÏãú Ï†úÏñ¥
    loadingDisplay.value[script] = false;
  }
};

// refÎ•º ÏÇ¨Ïö©ÌïòÏó¨ DOM ÏöîÏÜå Ï†ëÍ∑º Î∞©Ïãù ÏàòÏ†ï
const contentKey = `content-${script.replace(/\s+/g, "-")}`;
const contentElement = document.querySelector(`[data-content="${contentKey}"]`);

if (contentElement) {
  // ÌÉÄÏù¥Ìïë Ìö®Í≥º Ï†ÅÏö©
  typeText(contentElement, response.data.response);
  analyzedScripts.value[script] = true;
}
  } catch (error) {
  console.error("Analysis error:", error);
  const contentKey = `content-${script.replace(/\s+/g, "-")}`;
  const contentElement = document.querySelector(`[data-content="${contentKey}"]`);
  if (contentElement) {
    contentElement.innerHTML = '<p class="error">Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</p>';
  }
} finally {
  loadingDisplay.value[script] = false;
}
};

const getCookie = (name) => {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
};

const fetchMovieDetail = async () => {
  try {
    const tmdbId = route.params.tmdbId;
    const category = route.query.category;

    const auth = JSON.parse(localStorage.getItem("auth"));
    const token = auth?.token;

    const response = await axios.get(`http://localhost:8000/movie/movie_detail/${tmdbId}/`, {
      headers: {
        Authorization: `Token ${token}`,
      },
      params: {
        category: category,
      },
    });
    movieDetail.value = response.data;
  } catch (error) {
    console.error("Error fetching movie details:", error);
  }
};

// Ï∞úÌïòÍ∏∞ ÌÜ†Í∏Ä Ìï®Ïàò ÏàòÏ†ï
const toggleFavorite = async () => {
  try {
    const auth = JSON.parse(localStorage.getItem("auth"));
    if (!auth?.token) {
      alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
      return;
    }

    const response = await axios.get(`http://localhost:8000/movie/favorites/status/${movieDetail.value.tmdb_id}/`, { headers: { Authorization: `Token ${auth.token}` } });

    if (response.data.is_favorited) {
      await axios.delete(`http://localhost:8000/movie/favorites/${movieDetail.value.tmdb_id}/`, { headers: { Authorization: `Token ${auth.token}` } });
      isFavorite.value = false;
      favPopupMessage.value = "Removed from favorites!";
    } else {
      await axios.post(
        "http://localhost:8000/movie/favorites/",
        {
          movie_tmdb_id: movieDetail.value.tmdb_id,
          movie_title: movieDetail.value.title,
        },
        { headers: { Authorization: `Token ${auth.token}` } }
      );
      isFavorite.value = true;
      favPopupMessage.value = "Added to favorites!";
    }

    // ÌåùÏóÖ ÌëúÏãú Î∞è ÏûêÎèô Ïà®ÍπÄ
    showFavPopup.value = true;
    setTimeout(() => {
      showFavPopup.value = false;
    }, 2000);
  } catch (error) {
    console.error("Error:", error);
  }
};

const checkFavoriteStatus = async () => {
  try {
    const auth = JSON.parse(localStorage.getItem("auth"));
    if (!movieDetail.value?.tmdb_id || !auth?.token) return;

    const response = await axios.get(`http://localhost:8000/movie/favorites/status/${movieDetail.value.tmdb_id}/`, { headers: { Authorization: `Token ${auth.token}` } });
    isFavorite.value = response.data.is_favorited;
  } catch (error) {
    console.error("Error checking favorite status:", error);
  }
};
onMounted(async () => {
  await fetchMovieDetail();
  if (movieDetail.value) {
    checkFavoriteStatus();
  }

});
</script>

<style scoped>
.details-btn {
  padding: 10px 20px;
  border-radius: 8px;
  border: 2px solid #ff6b6b;
  background: white;
  color: #ff6b6b;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.details-btn:hover {
  background: #ff6b6b;
  color: white;
}

.movie-details-section {
  margin-top: 20px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 12px;
  animation: slideDown 0.3s ease;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.detail-label {
  font-weight: 600;
  color: #64748b;
}

.detail-value {
  font-size: 16px;
  color: #334155;
}

.detail-badge {
  align-self: flex-start;
  background: #e3f2fd;
  color: #ff6b6b;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

.cast-section {
  margin-top: 20px;
}

.cast-members {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 12px;
  margin-top: 10px;
}

.cast-member {
  background: white;
  padding: 12px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.actor-name {
  font-weight: 600;
  color: #334155;
}

.actor-character {
  font-size: 14px;
  color: #64748b;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 768px) {
  .action-buttons {
    flex-wrap: wrap;
  }

  .details-grid {
    grid-template-columns: 1fr;
  }
}

/* ======================== */

.recording-section {
  margin-top: 20px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 12px;
}

.record-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  background: #ff6b6b;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

.record-button.recording {
  background: #e74c3c;
  animation: pulse 2s infinite;
}

.audio-controls {
  margin-top: 15px;
  display: flex;
  gap: 10px;
  align-items: center;
}

.submit-button {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  background: #2ecc71;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
}

.submit-button:disabled {
  background: #95a5a6;
  cursor: not-allowed;
}

.result-section {
  margin-top: 20px;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.result-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.badges {
  display: flex;
  gap: 10px;
}

.match-badge {
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 600;
}

.match-badge.excellent {
  background: #e3fcef;
  color: #0f766e;
}

.match-badge.good {
  background: #e3f2fd;
  color: #ff6b6b;
}

.match-badge.needs-improvement {
  background: #fff3cd;
  color: #997404;
}

.new-record-badge {
  padding: 6px 12px;
  border-radius: 20px;
  background: #fdf2f8;
  color: #be185d;
  font-weight: 600;
}

.speech-comparison {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.label {
  font-weight: 600;
  color: #64748b;
  margin-bottom: 5px;
}

.text {
  padding: 10px;
  background: #f8fafc;
  border-radius: 6px;
  color: #334155;
}

@keyframes pulse {
  0% {
    opacity: 1;
  }

  50% {
    opacity: 0.6;
  }

  100% {
    opacity: 1;
  }
}

/* =============================== */

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-top: 30px;
  padding: 20px 0;
}

.page-numbers {
  display: flex;
  gap: 10px;
}

.page-number {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
  background: white;
  color: #2c3e50;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.page-number.active {
  background: #ff6b6b;
  color: white;
  border-color: #ff6b6b;
}

.page-number:hover:not(.active) {
  background: #f8f9fa;
  transform: translateY(-2px);
}

.pagination-btn {
  padding: 8px 16px;
  border-radius: 8px;
  background: #ff6b6b;
  color: white;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.pagination-btn:disabled {
  background: #95a5a6;
  cursor: not-allowed;
}

.pagination-btn:not(:disabled):hover {
  background: #ff6b6b;
  transform: translateY(-2px);
}

/* ================================== */

.popup-message {
  position: absolute;
  top: -40px;
  left: 50%;
  transform: translateX(-50%) translateY(10px);
  background: white;
  padding: 8px 16px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  font-size: 14px;
  color: #2c3e50;
  pointer-events: none;
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 6px;
  border: 2px solid #e8f5fe;
}

/* ÌåùÏóÖ ÌôîÏÇ¥Ìëú */
.popup-message::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 8px 8px 0 8px;
  border-style: solid;
  border-color: white transparent transparent transparent;
}

/* ÌåùÏóÖ ÌëúÏãú Ïï†ÎãàÎ©îÏù¥ÏÖò */
.popup-message.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ÌåùÏóÖ Ïù¥Î™®ÏßÄ Ïä§ÌÉÄÏùº */
.popup-emoji {
  font-size: 16px;
  line-height: 1;
}

/* Î≤ÑÌäº Í¥ÄÎ†® Ïä§ÌÉÄÏùº ÏàòÏ†ï */
.favorite-btn,
.word-chip {
  position: relative;
}

/* Ìò∏Î≤Ñ Ìö®Í≥º Í∞úÏÑ† */
.favorite-btn:hover,
.word-chip:hover {
  transform: translateY(-2px);
}

/* Î≤ÑÌäº ÌÅ¥Î¶≠ Ìö®Í≥º */
.favorite-btn:active,
.word-chip:active {
  transform: translateY(0);
}

/* Î∞òÏùëÌòï Ï°∞Ï†ï */
@media (max-width: 768px) {
  .popup-message {
    font-size: 12px;
    padding: 6px 12px;
  }
}

.movie-detail-container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 80%;
  padding: 0 50px;
}

.movie-header {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 30px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  max-width: 2000px;
  width: 100%;
}

.movie-basic-info {
  display: flex;
  gap: 30px;
}

.movie-poster {
  width: 200px;
  height: 300px;
  object-fit: cover;
  border-radius: 8px;
}

.movie-info {
  flex: 1;
}

.movie-title {
  font-size: 28px;
  color: #2c3e50;
  margin-bottom: 10px;
}

.release-date {
  color: #666;
  margin-bottom: 10px;
}

.overview {
  color: #2c3e50;
  line-height: 1.6;
  margin-bottom: 20px;
}

.action-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.favorite-btn,
.trailer-btn {
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.favorite-btn {
  border: 2px solid #ffd700;
  background: white;
}

.favorite-btn.is-favorite {
  background: #ffd700;
  color: white;
}

.trailer-btn {
  background: #ff6b6b;
  color: white;
  border: none;
}

.trailer-btn:hover {
  background: #ff6b6b;
}

.trailer-section {
  margin-top: 20px;
}

.script-analysis-section {
  background: white;
  border-radius: 12px;
  padding: 30px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  max-width: 2000px;
  width: 100%;
}

.section-title {
  font-size: 24px;
  color: #2c3e50;
  margin-bottom: 20px;
  padding-left: 20px;
  border-left: 4px solid #ff6b6b;
}

.script-card {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  transition: all 0.3s ease;
  position: relative;
}

.script-content {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.script-text {
  flex: 1;
  margin: 0;
}

.achievement-badge {
  position: absolute;
  top: 0;
  right: 10px;
  display: inline-flex;
  align-items: center;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.9em;
  font-weight: bold;
  white-space: nowrap;
  z-index: 2;
}

.achievement-badge.gold {
  background-color: #FFD700;
  color: #2C3E50;
  box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
}

.achievement-badge.silver {
  background-color: #C0C0C0;
  color: #2C3E50;
  box-shadow: 0 2px 4px rgba(192, 192, 192, 0.3);
}

.achievement-badge.bronze {
  background-color: #CD7F32;
  color: #FFFFFF;
  box-shadow: 0 2px 4px rgba(205, 127, 50, 0.3);
}

.achievement-badge i {
  margin-right: 6px;
}

/* ÎèôÏ†Å ÏÉùÏÑ±ÏùÑ ÏúÑÌïú Ìä∏ÎûúÏßÄÏÖò Ìö®Í≥º */
.badge-fade-enter-active {
  transition: all 0.3s ease-out;
}

.badge-fade-leave-active {
  transition: all 0.3s ease-in;
}

.badge-fade-enter-from,
.badge-fade-leave-to {
  opacity: 0;
  transform: translateX(20px);
}

/* Ïä§ÌÅ¨Î¶ΩÌä∏ Ïπ¥Îìú Ìò∏Î≤Ñ Ìö®Í≥ºÏóêÏÑúÎèÑ Î±ÉÏßÄÍ∞Ä Ïûò Î≥¥Ïù¥ÎèÑÎ°ù */
.script-card:hover .achievement-badge {
  z-index: 2;
}

.script-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.script-header {
  position: relative;
  margin-bottom: 15px;
}

/* script Î∂ÄÎ∂Ñ */
.script-text {
  font-size: 18px;
  color: #2c3e50;
  line-height: 1.8;
  margin-right: 120px;
  position: relative;
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 4px 8px;
  display: inline-block;
  /* ÌÖçÏä§Ìä∏ ÌÅ¨Í∏∞ÎßåÌÅºÎßå Ï∞®ÏßÄÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω */
}

/* Ïã¨ÌîåÌïú hover Ìö®Í≥º */
.script-text:hover {
  color: #ff6b6b;
  /* Î©îÏù∏ Ïª¨Îü¨Î°ú Î≥ÄÍ≤Ω */
  transform: translateX(4px);
  /* ÏÇ¥Ïßù Ïò§Î•∏Ï™ΩÏúºÎ°ú Ïù¥Îèô */
}

/* ÌÅ¥Î¶≠ Ìö®Í≥º */
.script-text:active {
  transform: translateX(2px);
  /* ÌÅ¥Î¶≠Ïãú ÏÇ¥Ïßù Îçú Ïù¥Îèô */
}


/* ============== */

.timestamp {
  color: #666;
  font-size: 14px;
}

.word-list {
  margin: 15px 0;
}

.words {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.word-chip {
  background: #e3f2fd;
  color: #ff6b6b;
  padding: 5px 12px;
  border-radius: 15px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.word-chip:hover {
  background: #ff6b6b;
  color: white;
}

.gpt-output {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-top: 15px;
  border: 1px solid #e0e0e0;
}

.loading {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #666;
}

.loading-spinner {
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #ff6b6b;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

@media (max-width: 768px) {
  .movie-basic-info {
    flex-direction: column;
  }

  .movie-poster {
    width: 100%;
    height: auto;
    max-width: 300px;
    margin: 0 auto;
  }
}

.movie-detail-container {
  max-width: 1200px;
  width: 100%;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 2rem;
  margin: 0 auto;
}

/* Ìó§Îçî ÏÑπÏÖò */
.movie-header {
  background: white;
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  width: 100%;
}

.movie-basic-info {
  display: flex;
  gap: 2rem;
}

.movie-poster {
  width: 200px;
  height: auto;
  object-fit: cover;
  border-radius: 8px;
}

.movie-info {
  flex: 1;
}

.movie-title {
  font-size: 2rem;
  color: #2c3e50;
  margin-bottom: 1rem;
}

.release-date {
  color: #666;
  margin-bottom: 1rem;
}

.overview {
  color: #2c3e50;
  line-height: 1.6;
  margin-bottom: 1.5rem;
}

.action-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.favorite-btn,
.trailer-btn,
.details-btn {
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 500;
}

.favorite-btn {
  border: 2px solid #ffd700;
  background: white;
  color: #ffd700;
}

.favorite-btn.is-favorite {
  background: #ffd700;
  color: white;
}

.trailer-btn {
  background: #ff6b6b;
  color: white;
  border: none;
}

.details-btn {
  border: 2px solid #ff6b6b;
  background: white;
  color: #ff6b6b;
}

.trailer-btn:hover,
.details-btn:hover {
  background: #ff8585;
  color: white;
  border-color: #ff8585;
}

/* ÏòÅÌôî ÏÑ∏Î∂Ä Ï†ïÎ≥¥ ÏÑπÏÖò */
.movie-details-section {
  margin-top: 1.5rem;
  padding: 1.5rem;
  background: #f8f9fa;
  border-radius: 12px;
  width: 96%;
  animation: fadeIn 0.5s ease-out;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

.detail-item {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.detail-label {
  font-weight: 600;
  color: #64748b;
}

.detail-value {
  font-size: 1rem;
  color: #334155;
}

.detail-badge {
  align-self: flex-start;
  background: #e3f2fd;
  color: #ff6b6b;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 600;
}

.cast-section {
  margin-top: 1.5rem;
}

.cast-members {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.cast-member {
  background: white;
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.actor-name {
  font-weight: 600;
  color: #334155;
}

.actor-character {
  font-size: 0.875rem;
  color: #64748b;
}

/* Ïä§ÌÅ¨Î¶ΩÌä∏ Î∂ÑÏÑù ÏÑπÏÖò */
.script-analysis-section {
  background: white;
  border-radius: 12px;
  padding: 2rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  width: 100%;
  margin-top: 2rem;
}

.section-title {
  font-size: 1.5rem;
  color: #2c3e50;
  margin-bottom: 1.5rem;
  padding-left: 1rem;
  border-left: 4px solid #ff6b6b;
}

/* ... ÎÇòÎ®∏ÏßÄ Ïä§ÌÉÄÏùº ... */

/* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
@media (max-width: 768px) {
  .movie-detail-container {
    padding: 1rem;
  }

  .movie-header,
  .script-analysis-section {
    padding: 1.5rem;
  }

  .movie-basic-info {
    flex-direction: column;
    gap: 1.5rem;
  }

  .movie-poster {
    width: 100%;
    max-width: 300px;
    margin: 0 auto;
  }

  .action-buttons {
    justify-content: center;
  }
}

/* Ïï†ÎãàÎ©îÏù¥ÏÖò */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.movie-detail-container {
  animation: fadeIn 0.6s ease-out;
}

.movie-header {
  animation: fadeIn 0.6s ease-out 0.2s;
  animation-fill-mode: both;
}

.script-analysis-section {
  animation: fadeIn 0.6s ease-out 0.4s;
  animation-fill-mode: both;
}
</style>
